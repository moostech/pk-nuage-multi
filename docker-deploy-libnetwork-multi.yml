# *** WARNING ***
# This file is automatically generated by build.yml.
# Changes made to this file may be overwritten.
# after installed use that way:
# docker network create --driver=nuage --ipam-driver=nuage-ipam --ipam-opt organization=ACME_Corp --ipam-opt domain=DC_domain --ipam-opt zone=DataCenter --ipam-opt subnet="Containers" --ipam-opt user=admin --subnet=192.1.60.0/24 --gateway=192.1.60.1 MyNuageNet
# docker network ls
# docker run -d -it --net MyNuageNet nginx /bin/bash

- hosts: docker[1-2].nuage511u1.lab
  remote_user: centos
  become: true
  become_method: sudo
  gather_facts: no
  
  tasks:
  
    - name: Pull facts on hypervisor
      action: setup
      remote_user: root
    
    - name: Install epel-release repo
      yum: name=epel-release state=present
      remote_user: root
    
    - name: yum updates
      yum: name=* state=latest
      remote_user: root

    - name: Install additional packages
      yum: name={{ item }} state=present
      with_items:
       - git
       - go
       - vim
      remote_user: root

    - name: Disabling selinux
      selinux:
        state: disabled
      remote_user: root

    - name: Install additional packages
      yum: name={{ item }} state=present
      with_items:
        - yum-utils
        - device-mapper-persistent-data
        - lvm2
      remote_user: root

    - name: Install docker-ce-stable yum repo
      yum_repository:
        name: "docker-ce-stable"
        description: "Docker CE Stable - $basearch"
        baseurl: "https://download.docker.com/linux/centos/7/$basearch/stable"
        gpgkey: "https://download.docker.com/linux/centos/gpg"
        gpgcheck: yes
        state: present
      remote_user: root

    - name: Ensure the yum package index is up to Date
      yum:
        update_cache: yes
        name: '*'
        state: latest
      remote_user: root

    - name: Install docker-ce packages
      yum: name=docker-ce state=present
      remote_user: root

    - file:
        path: /etc/docker
        state: directory
      remote_user: root

    - name: create /etc/docker/daemon.json
      template:
        src: daemon.json.j2
        dest: /etc/docker/daemon.json
      remote_user: root

    - name: Check docker service is running
      service:
        name: docker
        state: started
      remote_user: root
    
    - name: Remove  additional packages
      yum: name={{ item }} state=absent
      with_items:
       - python-openvswitch
       - openvswitch
      remote_user: root
    
    - name: install the nuage vrs openvswitch rpm from a remote repo
      yum:
        name: 'https://nuage-secure-files.s3.amazonaws.com/5.1.1u1-files/nuage-openvswitch5.1.1.rpm?Signature=O0zmgWUdFhZfsJZmig7zacQWaAE%3D&Expires=1510002585&AWSAccessKeyId=AKIAJRASYTVFMFESS6XA'
        state: present
      remote_user: root
    
    - name: Add ACTIVE_CONTROLLER to /etc/default/openvswitch
      lineinfile:
        dest: /etc/default/openvswitch
        regexp: 'ACTIVE_CONTROLLER='
        line: "ACTIVE_CONTROLLER=192.168.100.33"
      remote_user: root
    
    - name: Add STANDBY_CONTROLLER to /etc/default/openvswitch
      lineinfile:
        dest: /etc/default/openvswitch
        regexp: 'STANDBY_CONTROLLER='
        line: "STANDBY_CONTROLLER=192.168.100.34"
      remote_user: root
    
    - name : restarting openvswitch
      service:
        name: openvswitch
        state: restarted
      remote_user: root

# Installing docker and nuage related components
    
    - name: install libnetwork-nuage rpm from a remote repo
      yum:
        name: 'https://nuage-secure-files.s3.amazonaws.com/5.1.1u1-files/libnetwork5.1.1.rpm?Signature=5%2Ftbd8p7RmKgcDEYeMjBprF123g%3D&Expires=1510002582&AWSAccessKeyId=AKIAJRASYTVFMFESS6XA'
        state: present
      remote_user: root

    - name: Update url /etc/default/libnetwork-nuage.yaml
      lineinfile:
        dest: /etc/default/nuage-libnetwork.yaml
        regexp: 'url:'
        line: "url: https://192.168.100.20:8443"
        state: present
      remote_user: root

    - name: Update scope /etc/default/libnetwork-nuage.yaml
      lineinfile:
        dest: /etc/default/nuage-libnetwork.yaml
        regexp: 'scope:'
        line: 'scope: "local"'
        state: present
      remote_user: root
    
    - name : restarting libnetwork-nuage
      service:
        name: nuage-libnetwork
        state: restarted
      remote_user: root
