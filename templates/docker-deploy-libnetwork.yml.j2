# *** WARNING ***
# This file is automatically generated by build.yml.
# Changes made to this file may be overwritten.
# after installed use that way:
# docker network create --driver=nuage --ipam-driver=nuage-ipam --ipam-opt organization=ACME_Corp --ipam-opt domain=DC_domain --ipam-opt zone=DataCenter --ipam-opt subnet="Containers" --ipam-opt user=admin --subnet=192.1.60.0/24 --gateway=192.1.60.1 MyNuageNet
# docker network ls
# docker run -d -it --net MyNuageNet nginx /bin/bash

- hosts: docker
  remote_user: centos
  become: true
  become_method: sudo
  gather_facts: no
  
  tasks:
  
    - name: Pull facts on hypervisor
      action: setup
      remote_user: root
    
    - name: Install epel-release repo
      yum: name=epel-release state=present
      remote_user: root
    
    - name: yum updates
      yum: name=* state=latest
      remote_user: root
    
    - name: Install additional packages
      yum: name={{ '{' }}{{ '{' }} item {{ '}' }}{{ '}' }} state=present
      with_items:
       - python-twisted-core
       - qemu-kvm
       - libvirt
       - virt-install
      remote_user: root
    
    - name: Uncomment vnc_listen in /etc/libvirt/qemu.conf
      lineinfile:
        dest: /etc/libvirt/qemu.conf
        regexp: 'vnc_listen ='
        line: 'vnc_listen = 0.0.0.0'
      remote_user: root
    
    - name: Check libvirtd service is running
      service:
        name: libvirtd
        state: started 
      remote_user: root
    
    - name: Remove  additional packages
      yum: name={{ '{' }}{{ '{' }} item {{ '}' }}{{ '}' }} state=absent
      with_items:
       - python-openvswitch
       - openvswitch
      remote_user: root
    
    - name: install the nuage vrs openvswitch rpm from a remote repo
      yum:
        name: '{{ files_location }}{{ nuage_vrs_rpm_location }}'
        state: present
      remote_user: root
    
    - name: Remove  additional packages
      yum: name={{ '{' }}{{ '{' }} item {{ '}' }}{{ '}' }} state=absent
      with_items:
       - openvswitch
      remote_user: root
    
    - name: install the nuage vrs openvswitch rpm from a remote repo
      yum:
        name: '{{ files_location }}{{ nuage_vrs_rpm_location }}'
        state: present
      remote_user: root
    
    - name: Add ACTIVE_CONTROLLER to /etc/default/openvswitch
      lineinfile:
        dest: /etc/default/openvswitch
        regexp: 'ACTIVE_CONTROLLER='
        line: "ACTIVE_CONTROLLER={% if vsc_controllers[2].interfaces[1].ip is defined %}{{ vsc_controllers[2].interfaces[1].ip }}{% endif %}"
      remote_user: root
    
    - name: Add STANDBY_CONTROLLER to /etc/default/openvswitch
      lineinfile:
        dest: /etc/default/openvswitch
        regexp: 'STANDBY_CONTROLLER='
        line: "STANDBY_CONTROLLER={% if vsc_controllers[3].interfaces[1].ip is defined %}{{ vsc_controllers[3].interfaces[1].ip }}{% endif %}"
      remote_user: root
    
    - name : restarting openvswitch
      service:
        name: openvswitch
        state: restarted
      remote_user: root

# Installing docker and nuage related components
    
    - name: Install docker  packages
      yum: name={{ '{' }}{{ '{' }} item {{ '}' }}{{ '}' }} state=present
      with_items:
       - docker
       - python-pip
      remote_user: root
    
    - name: Installing pip packages and upgrade
      shell: "{{ '{' }}{{ '{' }} item {{ '}' }}{{ '}' }}"
      with_items:
       - 'pip install docker-py'
       - 'pip install --upgrade pip'
       - 'chkconfig docker on'
      remote_user: root
    
    - name : starting docker
      service:
        name: docker
        state: started
      remote_user: root
    
    - name: install libnetwork-nuage rpm from a remote repo
      yum:
        name: '{{ files_location }}{{ nuage_libnetwork_rpm_location }}'
        state: present
      remote_user: root

    - name: Update url /etc/default/libnetwork-nuage.yaml
      lineinfile:
        dest: /etc/default/nuage-libnetwork.yaml
        regexp: 'url:'
        line: "url: https://{{ core_instances[1].interfaces[0].ip }}:8443"
        state: present
      remote_user: root

    - name: Update scope /etc/default/libnetwork-nuage.yaml
      lineinfile:
        dest: /etc/default/nuage-libnetwork.yaml
        regexp: 'scope:'
        line: 'scope: "local"'
        state: present
      remote_user: root
    
    - name : restarting libnetwork-nuage
      service:
        name: nuage-libnetwork
        state: restarted
      remote_user: root
